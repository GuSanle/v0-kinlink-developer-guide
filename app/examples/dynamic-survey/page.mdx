import Link from "next/link";
import { ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { CodeBlock } from "@/components/code-block";
import {
  HighlightTabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "../highlight-tabs";

<div className="container py-6 lg:py-10">
  <div className="flex items-center gap-4 mb-8">
    <Link href="/examples">
      <Button variant="outline" size="icon">
        <ArrowLeft className="h-4 w-4" />
      </Button>
    </Link>
    <h1 className="text-3xl font-bold tracking-tight">动态调查</h1>
  </div>

  <div className="prose prose-blue dark:prose-invert max-w-none">
    <div className="lead">
      此示例演示如何创建一个动态调查表单，该表单能够根据用户响应自适应显示条件问题、分支逻辑和实时验证。
    </div>

    <h2>主要特性</h2>
    <ul>
      <li>基于先前答案显示的条件问题</li>
      <li>创建不同调查路径的分支逻辑</li>
      <li>响应的实时验证</li>
      <li>基于用户数据的动态问题生成</li>
      <li>进度跟踪和导航</li>
    </ul>

    <h2>实现方式</h2>
    <div>
      动态调查使用 Kinlink API 来管理问题可见性、验证和分支逻辑。以下是完整的代码：
    </div>

    <CodeBlock
      code={`(function() {
  // Survey configuration
  const SURVEY_CONFIG = {
    title: '客户满意度调查',
    description: '请通过这个简短的调查帮助我们改进产品和服务。',
    questions: [
      {
        id: 'customerType',
        text: '您是哪种类型的客户？',
        type: 'radio',
        options: ['新客户', '回头客', '潜在客户'],
        required: true
      },
      {
        id: 'productUsage',
        text: '您使用我们的哪些产品？',
        type: 'checkbox',
        options: ['产品 A', '产品 B', '产品 C', '无'],
        showIf: (values) => values.customerType === '回头客',
        required: true
      },
      {
        id: 'productInterest',
        text: '您对哪些产品感兴趣？',
        type: 'checkbox',
        options: ['产品 A', '产品 B', '产品 C', '还不确定'],
        showIf: (values) => values.customerType === '潜在客户',
        required: true
      },
      {
        id: 'productASatisfaction',
        text: '您对产品 A 的满意度如何？',
        type: 'rating',
        options: ['1', '2', '3', '4', '5'],
        showIf: (values) => values.productUsage && values.productUsage.includes('产品 A'),
        required: true
      },
      {
        id: 'productBSatisfaction',
        text: '您对产品 B 的满意度如何？',
        type: 'rating',
        options: ['1', '2', '3', '4', '5'],
        showIf: (values) => values.productUsage && values.productUsage.includes('产品 B'),
        required: true
      },
      {
        id: 'productCSatisfaction',
        text: '您对产品 C 的满意度如何？',
        type: 'rating',
        options: ['1', '2', '3', '4', '5'],
        showIf: (values) => values.productUsage && values.productUsage.includes('产品 C'),
        required: true
      },
      {
        id: 'improvementSuggestions',
        text: '您对我们如何改进产品有什么建议吗？',
        type: 'textarea',
        showIf: (values) => values.customerType === '回头客',
        required: false
      },
      {
        id: 'contactReason',
        text: '是什么促使您今天联系我们？',
        type: 'select',
        options: ['看到广告', '朋友推荐', '在线搜索', '其他'],
        showIf: (values) => values.customerType === '新客户' || values.customerType === '潜在客户',
        required: true
      },
      {
        id: 'otherContactReason',
        text: '请具体说明原因：',
        type: 'text',
        showIf: (values) => values.contactReason === '其他',
        required: true
      },
      {
        id: 'futureContact',
        text: '您希望我们就未来的产品和促销活动联系您吗？',
        type: 'radio',
        options: ['是', '否'],
        required: true
      },
      {
        id: 'contactMethod',
        text: '您希望我们通过什么方式联系您？',
        type: 'radio',
        options: ['邮箱', '电话', '邮寄'],
        showIf: (values) => values.futureContact === '是',
        required: true
      },
      {
        id: 'contactEmail',
        text: '请提供您的邮箱地址：',
        type: 'email',
        showIf: (values) => values.contactMethod === '邮箱',
        required: true,
        validator: (value) => {
          if (!value) return '邮箱地址是必填项';
          if (!/^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,3})+$/.test(value)) {
            return '请输入有效的邮箱地址';
          }
          return undefined;
        }
      },
      {
        id: 'contactPhone',
        text: '请提供您的电话号码：',
        type: 'tel',
        showIf: (values) => values.contactMethod === '电话',
        required: true,
        validator: (value) => {
          if (!value) return '电话号码是必填项';
          if (!/^\\+?[\\d\\s()-]{10,20}$/.test(value)) {
            return '请输入有效的电话号码';
          }
          return undefined;
        }
      },
      {
        id: 'contactAddress',
        text: '请提供您的邮寄地址：',
        type: 'textarea',
        showIf: (values) => values.contactMethod === '邮寄',
        required: true
      },
      {
        id: 'additionalComments',
        text: '您还有其他意见或反馈吗？',
        type: 'textarea',
        required: false
      }
    ]
  };
  
  // Initialize the form when it's loaded
  kinlink.events.on(kinlink.FormEvents.FORM_LOADED, () => {
    const form = kinlink.formApi;
    
    // Create survey title and description
    createSurveyHeader();
    
    // Create questions
    createQuestions();
    
    // Add validators
    addValidators();
    
    // Update question visibility based on initial values
    updateQuestionVisibility();
  });
  
  // Handle field changes
  kinlink.events.on(kinlink.FormEvents.FIELD_CHANGE, (data) => {
    // Update question visibility when any field changes
    updateQuestionVisibility();
  });
  
  // Function to create the survey header
  function createSurveyHeader() {
    const form = document.querySelector('form');
    
    const headerContainer = document.createElement('div');
    headerContainer.style.marginBottom = '2rem';
    
    const title = document.createElement('h2');
    title.textContent = SURVEY_CONFIG.title;
    title.style.fontSize = '1.5rem';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '0.5rem';
    
    const description = document.createElement('p');
    description.textContent = SURVEY_CONFIG.description;
    description.style.color = '#666';
    
    headerContainer.appendChild(title);
    headerContainer.appendChild(description);
    
    // Insert at the top of the form
    form.insertBefore(headerContainer, form.firstChild);
  }
  
  // Function to create questions
  function createQuestions() {
    // Questions are already defined in the Kinlink form
    // We just need to add custom styling and behavior
    
    SURVEY_CONFIG.questions.forEach(question => {
      const questionElement = document.querySelector(\`[data-field="\${question.id}"]\`);
      
      if (questionElement) {
        // Add question number and styling
        const labelElement = questionElement.querySelector('label');
        
        if (labelElement) {
          // Add required indicator
          if (question.required) {
            const requiredSpan = document.createElement('span');
            requiredSpan.textContent = ' *';
            requiredSpan.style.color = 'red';
            labelElement.appendChild(requiredSpan);
          }
        }
        
        // Add custom styling for rating questions
        if (question.type === 'rating') {
          const inputContainer = questionElement.querySelector('.input-container');
          
          if (inputContainer) {
            inputContainer.style.display = 'flex';
            inputContainer.style.gap = '0.5rem';
            
            const inputs = inputContainer.querySelectorAll('input[type="radio"]');
            const labels = inputContainer.querySelectorAll('label');
            
            inputs.forEach((input, index) => {
              const label = labels[index];
              
              if (label) {
                label.style.display = 'flex';
                label.style.flexDirection = 'column';
                label.style.alignItems = 'center';
                label.style.justifyContent = 'center';
                label.style.width = '40px';
                label.style.height = '40px';
                label.style.borderRadius = '50%';
                label.style.border = '1px solid #d9d9d9';
                label.style.cursor = 'pointer';
                
                input.addEventListener('change', () => {
                  // Reset all labels
                  labels.forEach(l => {
                    l.style.backgroundColor = '';
                    l.style.color = '';
                  });
                  
                  // Highlight selected label
                  if (input.checked) {
                    label.style.backgroundColor = '#1890ff';
                    label.style.color = 'white';
                  }
                });
              }
            });
          }
        }
      }
    });
  }
  
  // Function to add validators
  function addValidators() {
    const form = kinlink.formApi;
    
    SURVEY_CONFIG.questions.forEach(question => {
      if (question.validator) {
        form.addFieldValidator(question.id, question.validator);
      } else if (question.required) {
        form.addFieldValidator(question.id, (value) => {
          if (!value || (Array.isArray(value) && value.length === 0) || value === '') {
            return \`\${question.text} 是必填项\`;
          }
          return undefined;
        });
      }
    });
  }
  
  // Function to update question visibility
  function updateQuestionVisibility() {
    const form = kinlink.formApi;
    const values = form.getAllValues();
    
    SURVEY_CONFIG.questions.forEach(question => {
      if (question.showIf) {
        const shouldShow = question.showIf(values);
        
        if (shouldShow) {
          form.showField(question.id);
        } else {
          form.hideField(question.id);
          
          // Clear the value when hiding the field
          form.setFieldValue(question.id, '');
        }
      }
    });
  }
  
  // Validate the form before submission
  kinlink.events.on(kinlink.FormEvents.BEFORE_SUBMIT, (data) => {
    const form = kinlink.formApi;
    const values = form.getAllValues();
    
    // Validate only visible questions
    const visibleQuestions = SURVEY_CONFIG.questions.filter(question => {
      if (!question.showIf) return true;
      return question.showIf(values);
    });
    
    let isValid = true;
    
    visibleQuestions.forEach(question => {
      if (question.required) {
        const value = values[question.id];
        const isEmpty = !value || (Array.isArray(value) && value.length === 0) || value === '';
        
        if (isEmpty) {
          form.setFieldError(question.id, \`\${question.text} 是必填项\`);
          isValid = false;
        }
      }
      
      if (question.validator) {
        const error = question.validator(values[question.id]);
        if (error) {
          form.setFieldError(question.id, error);
          isValid = false;
        }
      }
    });
    
    if (!isValid) {
      form.showError('请在提交前修复验证错误。');
      return false;
    }
    
    // Add metadata to submission
    data.values.submittedAt = new Date().toISOString();
    
    return true;
  });
  
  // Handle successful submission
  kinlink.events.on(kinlink.FormEvents.AFTER_SUBMIT, (data) => {
    const { success } = data;
    const form = kinlink.formApi;
    
    if (success) {
      form.showSuccess('感谢您完成调查！');
    } else {
      form.showError('提交调查时出现错误，请重试。');
    }
  });
})();`}
      language="javascript"
      filename="dynamic-survey.js"
    />

    <h2>工作原理</h2>
    <div>
      此示例创建了一个动态客户满意度调查，能够根据用户的响应进行自适应。调查包含不同的问题类型（单选按钮、复选框、文本输入等），并使用条件逻辑根据先前的答案显示或隐藏问题。
    </div>

    <h3>调查配置</h3>
    <div>调查使用 JavaScript 对象进行配置，该对象定义了：</div>
    <ul>
      <li>调查标题和描述</li>
      <li>问题及其类型、选项和验证规则</li>
      <li>显示/隐藏问题的条件逻辑</li>
    </ul>

    <h3>关键实现细节</h3>
    <ul>
      <li>
        <strong>条件问题：</strong> 根据先前的答案显示或隐藏问题
      </li>
      <li>
        <strong>自定义验证：</strong> 每个问题都可以有自己的验证规则
      </li>
      <li>
        <strong>动态界面：</strong> 评分问题具有自定义样式和交互行为
      </li>
      <li>
        <strong>表单提交：</strong> 只有可见和必填的问题在提交前会被验证
      </li>
    </ul>

    <h2>最佳实践</h2>
    <ul>
      <li>
        <strong>渐进式披露：</strong> 只显示与用户相关的问题
      </li>
      <li>
        <strong>清晰说明：</strong> 提供清晰的说明并标明必填字段
      </li>
      <li>
        <strong>即时反馈：</strong> 实时验证响应
      </li>
      <li>
        <strong>逻辑流程：</strong> 按逻辑顺序组织问题
      </li>
      <li>
        <strong>响应式设计：</strong> 确保调查在所有设备上都能正常工作
      </li>
    </ul>

    <h2>自定义选项</h2>
    <div>此示例可以通过多种方式进行自定义：</div>
    <ul>
      <li>在调查配置中添加或修改问题</li>
      <li>更改问题类型和验证规则</li>
      <li>自定义问题和选项的外观</li>
      <li>实现更复杂的分支逻辑</li>
      <li>添加进度跟踪和导航</li>
    </ul>

    <div className="mt-8">
      <Link href="/examples">
        <Button variant="outline">
          <ArrowLeft className="mr-2 h-4 w-4" />
          返回示例
        </Button>
      </Link>
    </div>
  </div>
</div> 