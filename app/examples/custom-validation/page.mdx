import Link from "next/link";
import { ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { CodeBlock } from "@/components/code-block";
import {
  HighlightTabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "../highlight-tabs";
import { Metadata } from "next";

export const metadata: Metadata = {
  title: "自定义验证规则 - Kinlink开发者",
  description: "学习如何为表单字段添加自定义验证规则",
};

const sampleCode = `/**
 * 示例6: 自定义验证规则
 * 功能：为表单字段添加自定义验证规则
 */
(function () {
  kinlink.events.on(kinlink.FormEvents.FORM_LOADED, () => {
    try {
      const form = kinlink.formApi;

      // 为邮箱字段添加格式验证
      form.addFieldValidator('文字列__1行__3', (value) => {
        if (!value) return; // 非必填，空值不验证

        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(value)) {
          return '请输入有效的邮箱地址';
        }
        return undefined; // 验证通过
      });

      // 为手机号字段添加格式验证
      form.addFieldValidator('文字列__1行__2', (value) => {
        if (!value) return; // 非必填，空值不验证

        // 简单的手机号验证规则（不限制国家/地区前缀）
        const phoneRegex = /^\\+?[0-9]{7,15}$/;
        if (!phoneRegex.test(value)) {
          return '请输入有效的手机号码（7-15位数字，可以包含+号前缀）';
        }
        return undefined; // 验证通过
      });

      // 为护照有效期添加未过期验证
      form.addFieldValidator('日期_2', (value) => {
        if (!value) return; // 非必填，空值不验证

        const today = new Date();
        const expiryDate = new Date(value);

        // 确保日期有效
        if (isNaN(expiryDate.getTime())) {
          return '请输入有效的日期';
        }

        // 检查是否已过期
        if (expiryDate < today) {
          return '护照/证件已过期，请提供有效期内的证件';
        }

        // 检查是否即将过期（小于6个月）
        const sixMonthsLater = new Date();
        sixMonthsLater.setMonth(today.getMonth() + 6);

        if (expiryDate < sixMonthsLater) {
          // 这是警告而非错误，需手动显示
          form.showWarning(
            '您的护照/证件将在6个月内过期，可能影响某些国家/地区的入境要求',
          );
        }

        return undefined; // 验证通过
      });

      // 添加手动触发验证的按钮
      const validateButton = document.createElement('button');
      validateButton.textContent = '验证表单';
      validateButton.style.margin = '10px 0';
      validateButton.style.padding = '5px 10px';

      validateButton.addEventListener('click', () => {
        const result = form.validateForm();
        console.log('验证结果:', result);

        if (result.isValid) {
          form.showSuccess('表单验证通过');
        } else {
          form.showError('表单验证失败，请检查输入');
        }
      });

      // 添加按钮到表单
      const formElement = document.querySelector('.ant-form') || document.body;
      formElement.insertBefore(validateButton, formElement.firstChild);
    } catch (error) {
      console.error('添加自定义验证规则失败:', error);
    }
  });
})();
`;

<div className="container py-6 lg:py-10">
  <div className="flex items-center gap-4 mb-8">
    <Link href="/examples">
      <Button variant="outline" size="icon">
        <ArrowLeft className="h-4 w-4" />
      </Button>
    </Link>
    # 自定义验证规则
  </div>

  <div className="my-8 space-y-6">
    <div className="prose prose-blue dark:prose-invert max-w-none">
学习如何为表单字段添加自定义验证规则。

      <HighlightTabs defaultValue="overview">
        <TabsList className="mb-4">
          <TabsTrigger value="overview">概述</TabsTrigger>
          <TabsTrigger value="code">代码</TabsTrigger>
          <TabsTrigger value="usage">使用方法</TabsTrigger>
        </TabsList>

        <TabsContent value="overview" className="space-y-4">
          ## 您将学到什么
          * 如何为表单字段创建自定义验证规则
          * 如何实现带有视觉指示器的密码强度验证
          * 如何执行异步验证（例如，检查用户名是否可用）
          * 如何为用户提供实时反馈

          ## 主要特性
          * **密码强度验证：** 显示密码强度的视觉指示器
          * **异步验证：** 实时检查用户名可用性
          * **自定义错误消息：** 提供清晰、具体的错误消息
          * **视觉反馈：** 基于验证状态的颜色编码输入

          ## 使用场景
          * 带有用户名可用性检查的注册表单
          * 带有强度要求的密码创建表单
          * 带有复杂验证规则的表单
          * 需要针对外部数据源验证的表单
        </TabsContent>

        <TabsContent value="code">
          ## 完整示例
          此代码演示了注册表单中的高级验证技术，包括密码强度验证和异步用户名检查。

          <CodeBlock
            code={sampleCode}
            language="javascript"
            filename="custom-validation-example.js"
          />

          ### 表单结构
          此示例假设表单具有以下字段：

          <CodeBlock
            code={`{
    "revision": "901",
    "properties": {
        "レコード番号": {
            "type": "RECORD_NUMBER",
            "code": "レコード番号",
            "label": "レコード番号",
            "noLabel": false
        },
        "表格": {
            "type": "SUBTABLE",
            "code": "表格",
            "noLabel": false,
            "label": "表格",
            "fields": {
                "单行文本框_4": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "单行文本框_4",
                    "label": "单行文本框",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "多选_1": {
                    "type": "MULTI_SELECT",
                    "code": "多选_1",
                    "label": "多选",
                    "noLabel": false,
                    "required": false,
                    "options": {
                        "sample1": {
                            "label": "sample1",
                            "index": "0"
                        },
                        "sample4": {
                            "label": "sample4",
                            "index": "3"
                        },
                        "sample3": {
                            "label": "sample3",
                            "index": "2"
                        },
                        "sample2": {
                            "label": "sample2",
                            "index": "1"
                        }
                    },
                    "defaultValue": []
                }
            }
        },
        "更新者": {
            "type": "MODIFIER",
            "code": "更新者",
            "label": "更新者",
            "noLabel": false
        },
        "ステータス": {
            "type": "STATUS",
            "code": "ステータス",
            "label": "ステータス",
            "enabled": true
        },
        "カテゴリー": {
            "type": "CATEGORY",
            "code": "カテゴリー",
            "label": "カテゴリー",
            "enabled": false
        },
        "附件_0": {
            "type": "FILE",
            "code": "附件_0",
            "label": "パスポート写真",
            "noLabel": false,
            "required": false,
            "thumbnailSize": "150"
        },
        "单行文本框_0": {
            "type": "SINGLE_LINE_TEXT",
            "code": "单行文本框_0",
            "label": "案件名",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "单行文本框_10": {
            "type": "SINGLE_LINE_TEXT",
            "code": "单行文本框_10",
            "label": "会社名",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "单行文本框_11": {
            "type": "SINGLE_LINE_TEXT",
            "code": "单行文本框_11",
            "label": "パスポート番号／身分証番号",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "日期_1": {
            "type": "DATE",
            "code": "日期_1",
            "label": "生年月日",
            "noLabel": false,
            "required": false,
            "unique": false,
            "defaultValue": "",
            "defaultNowValue": false
        },
        "日期_2": {
            "type": "DATE",
            "code": "日期_2",
            "label": "パスポート有効期限",
            "noLabel": false,
            "required": false,
            "unique": false,
            "defaultValue": "",
            "defaultNowValue": false
        },
        "作業者": {
            "type": "STATUS_ASSIGNEE",
            "code": "作業者",
            "label": "作業者",
            "enabled": true
        },
        "作成者": {
            "type": "CREATOR",
            "code": "作成者",
            "label": "作成者",
            "noLabel": false
        },
        "单行文本框_9": {
            "type": "SINGLE_LINE_TEXT",
            "code": "单行文本框_9",
            "label": "ローマ字名",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "下拉菜单": {
            "type": "DROP_DOWN",
            "code": "下拉菜单",
            "label": "集合場所",
            "noLabel": false,
            "required": false,
            "options": {
                "x x x 3q": {
                    "label": "x x x 3q",
                    "index": "28"
                },
                "65 x x x2 q": {
                    "label": "65 x x x2 q",
                    "index": "26"
                },
                "x x12 x q": {
                    "label": "x x12 x q",
                    "index": "38"
                },
                "x x x q7678": {
                    "label": "x x x q7678",
                    "index": "50"
                },
                "x 2x x q54": {
                    "label": "x 2x x q54",
                    "index": "18"
                },
                "x x x q123": {
                    "label": "x x x q123",
                    "index": "12"
                },
                "x x x q65": {
                    "label": "x x x q65",
                    "index": "48"
                },
                "x x x5433 q": {
                    "label": "x x x5433 q",
                    "index": "42"
                },
                "7 x x x q": {
                    "label": "7 x x x q",
                    "index": "8"
                },
                "x 8x x q": {
                    "label": "x 8x x q",
                    "index": "24"
                },
                "x 4x x q": {
                    "label": "x 4x x q",
                    "index": "20"
                },
                "x x x 87q": {
                    "label": "x x x 87q",
                    "index": "46"
                },
                "x x 33x q": {
                    "label": "x x 33x q",
                    "index": "40"
                },
                "x x x 67q": {
                    "label": "x x x 67q",
                    "index": "33"
                },
                "65 x x x q9": {
                    "label": "65 x x x q9",
                    "index": "47"
                },
                "x x x q17": {
                    "label": "x x x q17",
                    "index": "16"
                },
                "x x x q16": {
                    "label": "x x x q16",
                    "index": "15"
                },
                "x x x q15": {
                    "label": "x x x q15",
                    "index": "14"
                },
                "x x x q14": {
                    "label": "x x x q14",
                    "index": "13"
                },
                "x x43 x q": {
                    "label": "x x43 x q",
                    "index": "43"
                },
                "12 x x x q": {
                    "label": "12 x x x q",
                    "index": "11"
                },
                "x x x333 q x x x q": {
                    "label": "x x x333 q x x x q",
                    "index": "41"
                },
                "A": {
                    "label": "A",
                    "index": "0"
                },
                "8 x x x q": {
                    "label": "8 x x x q",
                    "index": "9"
                },
                "x11 x x q243": {
                    "label": "x11 x x q243",
                    "index": "37"
                },
                "B": {
                    "label": "B",
                    "index": "1"
                },
                "x 5x x q": {
                    "label": "x 5x x q",
                    "index": "21"
                },
                "x x x q4": {
                    "label": "x x x q4",
                    "index": "5"
                },
                "x x x q3": {
                    "label": "x x x q3",
                    "index": "4"
                },
                "x x x45 q": {
                    "label": "x x x45 q",
                    "index": "49"
                },
                "x x x q2": {
                    "label": "x x x q2",
                    "index": "3"
                },
                "x7 x x q": {
                    "label": "x7 x x q",
                    "index": "23"
                },
                "x x x q1": {
                    "label": "x x x q1",
                    "index": "2"
                },
                "x x x q6": {
                    "label": "x x x q6",
                    "index": "7"
                },
                "x x x q5": {
                    "label": "x x x q5",
                    "index": "6"
                },
                "54 x x x q6": {
                    "label": "54 x x x q6",
                    "index": "32"
                },
                "x x x 8q54": {
                    "label": "x x x 8q54",
                    "index": "34"
                },
                "x x x q x x x4 q x x x q": {
                    "label": "x x x q x x x4 q x x x q",
                    "index": "29"
                },
                "x x x132 q x x x q": {
                    "label": "x x x132 q x x x q",
                    "index": "39"
                },
                "x 3x x q": {
                    "label": "x 3x x q",
                    "index": "19"
                },
                "x x x 65q": {
                    "label": "x x x 65q",
                    "index": "44"
                },
                "x x x q9": {
                    "label": "x x x q9",
                    "index": "10"
                },
                "x x x q76": {
                    "label": "x x x q76",
                    "index": "45"
                },
                "x 9x x q": {
                    "label": "x 9x x q",
                    "index": "25"
                },
                "x x x 10q76": {
                    "label": "x x x 10q76",
                    "index": "36"
                },
                "x 6x x q": {
                    "label": "x 6x x q",
                    "index": "22"
                },
                "x 1x x q5": {
                    "label": "x 1x x q5",
                    "index": "17"
                },
                "x x x5 q544": {
                    "label": "x x x5 q544",
                    "index": "30"
                },
                "x x x q x x x q x x x q": {
                    "label": "x x x q x x x q x x x q",
                    "index": "27"
                },
                "x x x 9q65": {
                    "label": "x x x 9q65",
                    "index": "35"
                },
                "x x 56x q": {
                    "label": "x x 56x q",
                    "index": "31"
                }
            },
            "defaultValue": ""
        },
        "文字列__1行__0": {
            "type": "SINGLE_LINE_TEXT",
            "code": "文字列__1行__0",
            "label": "漢字姓",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "文字列__1行__1": {
            "type": "SINGLE_LINE_TEXT",
            "code": "文字列__1行__1",
            "label": "漢字名",
            "noLabel": false,
            "required": true,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "单行文本框_8": {
            "type": "SINGLE_LINE_TEXT",
            "code": "单行文本框_8",
            "label": "ローマ字姓",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "更新日時": {
            "type": "UPDATED_TIME",
            "code": "更新日時",
            "label": "更新日時",
            "noLabel": false
        },
        "单选框_0": {
            "type": "RADIO_BUTTON",
            "code": "单选框_0",
            "label": "性別",
            "noLabel": false,
            "required": true,
            "options": {
                "女": {
                    "label": "女",
                    "index": "1"
                },
                "男": {
                    "label": "男",
                    "index": "0"
                }
            },
            "defaultValue": "男",
            "align": "HORIZONTAL"
        },
        "文字列__1行__2": {
            "type": "SINGLE_LINE_TEXT",
            "code": "文字列__1行__2",
            "label": "携帯電話",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "文字列__1行__3": {
            "type": "SINGLE_LINE_TEXT",
            "code": "文字列__1行__3",
            "label": "Eメールアドレス",
            "noLabel": false,
            "required": false,
            "minLength": "",
            "maxLength": "",
            "expression": "",
            "hideExpression": false,
            "unique": false,
            "defaultValue": ""
        },
        "选择用户": {
            "type": "USER_SELECT",
            "code": "选择用户",
            "label": "担当者",
            "noLabel": false,
            "required": false,
            "entities": [],
            "defaultValue": []
        },
        "表格_13": {
            "type": "SUBTABLE",
            "code": "表格_13",
            "noLabel": false,
            "label": "同行者",
            "fields": {
                "文字列__1行__4": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "文字列__1行__4",
                    "label": "漢字姓",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "单行文本框_3": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "单行文本框_3",
                    "label": "パスポート番号／身分証番号",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "附件": {
                    "type": "FILE",
                    "code": "附件",
                    "label": "パスポート写真",
                    "noLabel": false,
                    "required": true,
                    "thumbnailSize": "150"
                },
                "单行文本框": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "单行文本框",
                    "label": "ローマ字姓",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "文字列__1行__5": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "文字列__1行__5",
                    "label": "携帯電話",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "单行文本框_1": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "单行文本框_1",
                    "label": "ローマ字名",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "单行文本框_2": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "单行文本框_2",
                    "label": "会社名",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "文字列__1行__6": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "文字列__1行__6",
                    "label": "Eメールアドレス",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "日期": {
                    "type": "DATE",
                    "code": "日期",
                    "label": "パスポート有効期限",
                    "noLabel": false,
                    "required": false,
                    "unique": false,
                    "defaultValue": "",
                    "defaultNowValue": false
                },
                "文字列__1行_": {
                    "type": "SINGLE_LINE_TEXT",
                    "code": "文字列__1行_",
                    "label": "漢字名",
                    "noLabel": false,
                    "required": false,
                    "minLength": "",
                    "maxLength": "",
                    "expression": "",
                    "hideExpression": false,
                    "unique": false,
                    "defaultValue": ""
                },
                "单选框": {
                    "type": "RADIO_BUTTON",
                    "code": "单选框",
                    "label": "性別",
                    "noLabel": false,
                    "required": true,
                    "options": {
                        "女": {
                            "label": "女",
                            "index": "1"
                        },
                        "男": {
                            "label": "男",
                            "index": "0"
                        }
                    },
                    "defaultValue": "男",
                    "align": "HORIZONTAL"
                },
                "复选框_0": {
                    "type": "CHECK_BOX",
                    "code": "复选框_0",
                    "label": "复选框",
                    "noLabel": false,
                    "required": false,
                    "options": {
                        "sa1": {
                            "label": "sa1",
                            "index": "0"
                        },
                        "sa2": {
                            "label": "sa2",
                            "index": "1"
                        }
                    },
                    "defaultValue": [],
                    "align": "HORIZONTAL"
                }
            }
        },
        "Lookup_0": {
            "type": "SINGLE_LINE_TEXT",
            "code": "Lookup_0",
            "label": "案件编号",
            "noLabel": false,
            "required": false,
            "lookup": null
        },
        "选择用户_1": {
            "type": "USER_SELECT",
            "code": "选择用户_1",
            "label": "副担当者",
            "noLabel": false,
            "required": false,
            "entities": [],
            "defaultValue": []
        },
        "多选_0": {
            "type": "MULTI_SELECT",
            "code": "多选_0",
            "label": "このツアーはどこでお知りになりましたか",
            "noLabel": false,
            "required": false,
            "options": {
                "Wechat JTB日本語サイト": {
                    "label": "Wechat JTB日本語サイト",
                    "index": "0"
                },
                "その他JTB上海からのご案内": {
                    "label": "その他JTB上海からのご案内",
                    "index": "1"
                },
                "らくらくプレス": {
                    "label": "らくらくプレス",
                    "index": "2"
                },
                "Whenever": {
                    "label": "Whenever",
                    "index": "3"
                },
                "ジャピオン": {
                    "label": "ジャピオン",
                    "index": "4"
                }
            },
            "defaultValue": []
        },
        "作成日時": {
            "type": "CREATED_TIME",
            "code": "作成日時",
            "label": "作成日時",
            "noLabel": false
        },
        "选择组织": {
            "type": "ORGANIZATION_SELECT",
            "code": "选择组织",
            "label": "担当部署",
            "noLabel": false,
            "required": false,
            "entities": [],
            "defaultValue": []
        }
    }
}`}
            language="html"
            filename="form-structure.html"
          />
        </TabsContent>

        <TabsContent value="usage">
          ## 如何使用此示例

          ### 步骤1：创建您的表单
          首先，在您的Kinlink仪表板中创建一个具有表单结构中所示字段的表单。确保使用与示例代码中相同的字段名称。

          ### 步骤2：添加JavaScript代码
          从"代码"选项卡复制JavaScript代码，并将其粘贴到Kinlink表单的自定义JavaScript部分。

          ### 步骤3：测试您的表单
          预览您的表单并测试以下功能：
          * 输入不同的用户名以查看可用性检查的运行情况
          * 尝试输入不同强度的密码，查看强度指示器的变化
          * 测试密码确认匹配
          * 使用有效和无效数据提交表单

          ### 自定义选项
          您可以通过多种方式自定义此示例：
          * 修改密码强度要求
          * 更改强度指示器的视觉外观
          * 添加更多具有自定义验证规则的字段
          * 实现用户名可用性检查的真实API调用

          ### 最佳实践
          * **实时反馈：** 在用户输入时提供即时反馈
          * **清晰的错误消息：** 使错误消息具体且有帮助
          * **视觉提示：** 使用颜色和指示器显示验证状态
          * **性能：** 防抖API调用以防止过多请求
        </TabsContent>
      </HighlightTabs>

      <div className="mt-8 flex flex-col sm:flex-row gap-4">
        <Link href="/examples">
          <Button variant="outline">
            <ArrowLeft className="mr-2 h-4 w-4" />
            返回示例
          </Button>
        </Link>
        <Link href="/docs/guides/form-validation">
          <Button variant="secondary">查看表单验证指南</Button>
        </Link>
      </div>
    </div>
  </div>
</div>
