import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CodeBlock } from "@/components/code-block";
import Link from "next/link";
import { ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";

<div className="container max-w-4xl py-6 lg:py-10 mdx-content">
  <div className="flex items-center gap-4 mb-8">
    <Link href="/examples" className="flex items-center">
      <Button variant="outline" size="icon" className="h-10 w-10 flex items-center justify-center">
        <ArrowLeft className="h-4 w-4" />
      </Button>
    </Link>
    <h1 className="text-3xl font-bold tracking-tight m-0 p-0 leading-[1.2] flex items-center">Kinlinkä»£ç†ç¤ºä¾‹</h1>
  </div>

  <div className="space-y-8 px-8">
    <div>
      <h2>APIä»£ç†ç³»ç»Ÿæ¦‚è§ˆ</h2>
      
      > æ„å»ºå¼ºå¤§çš„åç«¯é›†æˆèƒ½åŠ›ï¼Œå®ç°æ•°æ®åŒæ­¥å’Œä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–

      æ­¤ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨**kinlink proxy API**ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼Œå®ç°æ•°æ®çš„**åŒå‘åŒæ­¥**ã€**å®æ—¶å¤„ç†**å’Œ**ä¸šåŠ¡è‡ªåŠ¨åŒ–**ã€‚é€šè¿‡ä»£ç†æœåŠ¡ï¼Œå¯ä»¥å®‰å…¨åœ°ä¸ä¼ä¸šå†…éƒ¨ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹APIå’Œäº‘æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚

      ### APIä»£ç†æ ¸å¿ƒåŠŸèƒ½
      - ğŸ”— **å¤–éƒ¨é›†æˆ**ï¼šä¸ç¬¬ä¸‰æ–¹APIå’Œå†…éƒ¨ç³»ç»Ÿæ— ç¼å¯¹æ¥
      - ğŸ” **å®‰å…¨é€šä¿¡**ï¼šåŠ å¯†ä¼ è¾“å’Œèº«ä»½éªŒè¯æœºåˆ¶
      - ğŸ”„ **æ•°æ®åŒæ­¥**ï¼šå®æ—¶æˆ–æ‰¹é‡æ•°æ®åŒæ­¥å¤„ç†
      - âš¡ **é«˜æ€§èƒ½**ï¼šå¼‚æ­¥å¤„ç†å’Œè¯·æ±‚ä¼˜åŒ–
      - ğŸ“Š **ç›‘æ§æ—¥å¿—**ï¼šå®Œæ•´çš„è¯·æ±‚è¿½è¸ªå’Œé”™è¯¯å¤„ç†
      - ğŸ›¡ï¸ **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨é‡è¯•å’Œæ•…éšœè½¬ç§»æœºåˆ¶
    </div>

    <div>
      <h2>å…³é”®åŠŸèƒ½</h2>
      <ul>
        <li>HTTPè¯·æ±‚ä»£ç†å’Œè½¬å‘</li>
        <li>æ•°æ®æ ¼å¼è½¬æ¢å’Œæ˜ å°„</li>
        <li>è®¤è¯å’Œæƒé™ç®¡ç†</li>
        <li>é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</li>
      </ul>
    </div>

    <div>
      <h2>ä»£ç ç¤ºä¾‹</h2>
      <div className="-ml-8">
        <Tabs defaultValue="javascript">
          <TabsList className="ml-8">
            <TabsTrigger value="javascript">JavaScript</TabsTrigger>
          </TabsList>
          <TabsContent value="javascript" className="mt-4">
            <CodeBlock 
              code={`/**
 * ç¤ºä¾‹14: Kinlinkä»£ç†é›†æˆ
 * åŠŸèƒ½ï¼šä½¿ç”¨ä»£ç†APIä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼Œå®ç°æ•°æ®åŒæ­¥å’Œä¸šåŠ¡è‡ªåŠ¨åŒ–
 */
(function () {
  // ä»£ç†é…ç½®
  const PROXY_CONFIG = {
    baseUrl: 'https://api.example.com',
    endpoints: {
      users: '/api/users',
      orders: '/api/orders',
      notifications: '/api/notifications',
      validation: '/api/validate'
    },
    timeout: 10000,
    retryCount: 3,
    retryDelay: 1000
  };

  // è®¤è¯é…ç½®
  const AUTH_CONFIG = {
    type: 'bearer', // æˆ– 'basic', 'api-key'
    token: null,
    refreshUrl: '/api/auth/refresh'
  };

  // è¯·æ±‚é˜Ÿåˆ—å’ŒçŠ¶æ€ç®¡ç†
  let requestQueue = [];
  let isProcessingQueue = false;
  let authToken = null;

  kinlink.events.on(kinlink.FormEvents.FORM_LOADED, () => {
    try {
      console.log('åˆå§‹åŒ–Kinlinkä»£ç†ç³»ç»Ÿ...');
      
      // åˆ›å»ºä»£ç†ç®¡ç†é¢æ¿
      createProxyDashboard();
      
      // åˆå§‹åŒ–è®¤è¯
      initializeAuth();
      
      // è®¾ç½®è¡¨å•äº‹ä»¶ç›‘å¬
      setupFormEventListeners();
      
      // å¯åŠ¨å®šæ—¶ä»»åŠ¡
      startPeriodicTasks();
      
      console.log('Kinlinkä»£ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
      
    } catch (error) {
      console.error('ä»£ç†ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
    }
  });

  // åˆ›å»ºä»£ç†ç®¡ç†é¢æ¿
  function createProxyDashboard() {
    const dashboardHTML = \`
      <div id="proxyDashboard" style="
        background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%);
        padding: 25px;
        margin: 20px 0;
        border-radius: 15px;
        color: white;
        box-shadow: 0 6px 25px rgba(142, 68, 173, 0.3);
      ">
        <div style="text-align: center; margin-bottom: 25px;">
          <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700;">
            ğŸ”— Kinlinkä»£ç†ç³»ç»Ÿ
          </h2>
          <div style="font-size: 15px; opacity: 0.95;">
            å®æ—¶ç›‘æ§å¤–éƒ¨APIé›†æˆçŠ¶æ€å’Œæ•°æ®åŒæ­¥
          </div>
        </div>
        
        <div id="proxyStats" style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
        ">
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;" id="totalRequests">0</div>
            <div style="font-size: 13px; opacity: 0.9;">æ€»è¯·æ±‚æ•°</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;" id="successRate">100%</div>
            <div style="font-size: 13px; opacity: 0.9;">æˆåŠŸç‡</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;" id="queueLength">0</div>
            <div style="font-size: 13px; opacity: 0.9;">é˜Ÿåˆ—é•¿åº¦</div>
          </div>
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;" id="connectionStatus">è¿æ¥ä¸­</div>
            <div style="font-size: 13px; opacity: 0.9;">è¿æ¥çŠ¶æ€</div>
      </div>
    </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
          <button id="testConnection" style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;">
            ğŸ” æµ‹è¯•è¿æ¥
          </button>
          <button id="syncData" style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;">
            ğŸ”„ åŒæ­¥æ•°æ®
          </button>
          <button id="clearQueue" style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;">
            ğŸ—‘ï¸ æ¸…ç©ºé˜Ÿåˆ—
          </button>
          <button id="showLogs" style="padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;">
            ğŸ“‹ æŸ¥çœ‹æ—¥å¿—
          </button>
        </div>
        
        <div id="requestLog" style="
          background: rgba(0,0,0,0.2);
          padding: 15px;
          border-radius: 8px;
          max-height: 200px;
          overflow-y: auto;
          font-size: 12px;
          font-family: monospace;
          line-height: 1.4;
        ">
          <div>ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…APIè¯·æ±‚...</div>
        </div>
      </div>
    \`;

    // æ’å…¥é¢æ¿åˆ°è¡¨å•é¡¶éƒ¨
    const formElement = document.querySelector('.ant-form') || document.body;
    const dashboardElement = document.createElement('div');
    dashboardElement.innerHTML = dashboardHTML;
    formElement.insertBefore(dashboardElement, formElement.firstChild);

    // ç»‘å®šé¢æ¿äº‹ä»¶
    bindDashboardEvents();
  }

  // ç»‘å®šé¢æ¿äº‹ä»¶
  function bindDashboardEvents() {
    const dashboard = document.getElementById('proxyDashboard');
    if (!dashboard) return;

    dashboard.addEventListener('click', async (e) => {
      const target = e.target;
      
      if (target.id === 'testConnection') {
        await testApiConnection();
      } else if (target.id === 'syncData') {
        await performDataSync();
      } else if (target.id === 'clearQueue') {
        clearRequestQueue();
      } else if (target.id === 'showLogs') {
        showDetailedLogs();
      }
    });
  }

  // åˆå§‹åŒ–è®¤è¯
  async function initializeAuth() {
    try {
      // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ä»¤ç‰Œ
      const storedToken = localStorage.getItem('kinlink_proxy_token');
      if (storedToken) {
        authToken = storedToken;
        AUTH_CONFIG.token = storedToken;
      }

      // éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
      if (authToken) {
        const isValid = await validateToken(authToken);
        if (!isValid) {
          await refreshAuthToken();
        }
      } else {
        await requestNewToken();
      }

      logMessage('è®¤è¯åˆå§‹åŒ–å®Œæˆ', 'success');
    } catch (error) {
      logMessage(\`è®¤è¯å¤±è´¥: \${error.message}\`, 'error');
    }
  }

  // éªŒè¯ä»¤ç‰Œ
  async function validateToken(token) {
    try {
      const response = await makeProxyRequest('/api/auth/validate', {
        method: 'POST',
        headers: {
          'Authorization': \`Bearer \${token}\`,
          'Content-Type': 'application/json'
        }
      });

      return response.status === 200;
    } catch (error) {
      return false;
    }
  }

  // åˆ·æ–°è®¤è¯ä»¤ç‰Œ
  async function refreshAuthToken() {
    try {
      const response = await makeProxyRequest(AUTH_CONFIG.refreshUrl, {
        method: 'POST',
        headers: {
          'Authorization': \`Bearer \${authToken}\`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        authToken = data.token;
        AUTH_CONFIG.token = authToken;
        localStorage.setItem('kinlink_proxy_token', authToken);
        logMessage('ä»¤ç‰Œåˆ·æ–°æˆåŠŸ', 'success');
      } else {
        throw new Error('ä»¤ç‰Œåˆ·æ–°å¤±è´¥');
      }
    } catch (error) {
      logMessage(\`ä»¤ç‰Œåˆ·æ–°å¤±è´¥: \${error.message}\`, 'error');
      await requestNewToken();
    }
  }

  // è¯·æ±‚æ–°ä»¤ç‰Œ
  async function requestNewToken() {
    // è¿™é‡Œåº”è¯¥å®ç°è·å–æ–°ä»¤ç‰Œçš„é€»è¾‘
    // å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ–ä½¿ç”¨å…¶ä»–è®¤è¯æ–¹å¼
    logMessage('éœ€è¦é‡æ–°è®¤è¯', 'warning');
  }

  // è®¾ç½®è¡¨å•äº‹ä»¶ç›‘å¬
  function setupFormEventListeners() {
    // ç›‘å¬è¡¨å•æäº¤å‰äº‹ä»¶
    kinlink.events.on(kinlink.FormEvents.BEFORE_SUBMIT, handleBeforeSubmit);
        
    // ç›‘å¬è¡¨å•æäº¤åäº‹ä»¶
    kinlink.events.on(kinlink.FormEvents.AFTER_SUBMIT, handleAfterSubmit);
    
    // ç›‘å¬å­—æ®µå€¼å˜åŒ–
    kinlink.events.on(kinlink.FormEvents.FIELD_VALUE_CHANGED, handleFieldChange);
  }

  // å¤„ç†æäº¤å‰äº‹ä»¶
  async function handleBeforeSubmit(data) {
    try {
      logMessage('å¼€å§‹è¡¨å•éªŒè¯...', 'info');
      
      // è°ƒç”¨å¤–éƒ¨éªŒè¯API
      const validationResult = await validateFormData(data.values);
      
      if (!validationResult.valid) {
        kinlink.formApi.showMessage('error', \`éªŒè¯å¤±è´¥: \${validationResult.message}\`, 5);
        return false; // é˜»æ­¢æäº¤
      }
      
      logMessage('è¡¨å•éªŒè¯é€šè¿‡', 'success');
      return true;
    } catch (error) {
      logMessage(\`éªŒè¯è¿‡ç¨‹å‡ºé”™: \${error.message}\`, 'error');
      kinlink.formApi.showMessage('error', 'éªŒè¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•', 3);
      return false;
    }
          }
          
  // å¤„ç†æäº¤åäº‹ä»¶
  async function handleAfterSubmit(data) {
    if (data.success) {
      try {
        logMessage('å¼€å§‹æ•°æ®åŒæ­¥...', 'info');
        
        // åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿ
        await syncToExternalSystems(data.submittedData);
        
        // å‘é€é€šçŸ¥
        await sendNotifications(data.submittedData);
        
        logMessage('æ•°æ®åŒæ­¥å®Œæˆ', 'success');
      } catch (error) {
        logMessage(\`åŒæ­¥å¤±è´¥: \${error.message}\`, 'error');
      }
    }
  }

  // å¤„ç†å­—æ®µå˜åŒ–
  async function handleFieldChange(data) {
    const { fieldCode, value } = data;
    
    // å¯¹ç‰¹å®šå­—æ®µè¿›è¡Œå®æ—¶éªŒè¯
    if (fieldCode === 'æ–‡å­—åˆ—__1è¡Œ__3') { // é‚®ç®±å­—æ®µ
      await validateEmailField(value);
    }
    
    // æ›´æ–°å¤–éƒ¨ç³»ç»Ÿçš„è‰ç¨¿
    queueRequest({
      type: 'UPDATE_DRAFT',
      fieldCode,
      value,
      timestamp: new Date().toISOString()
    });
  }

  // æ‰§è¡Œä»£ç†è¯·æ±‚
  async function makeProxyRequest(endpoint, options = {}) {
    const url = \`\${PROXY_CONFIG.baseUrl}\${endpoint}\`;
    
    const requestOptions = {
      timeout: PROXY_CONFIG.timeout,
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authToken ? \`Bearer \${authToken}\` : undefined,
        ...options.headers
      }
    };

    try {
      // ä½¿ç”¨kinlinkçš„ä»£ç†åŠŸèƒ½
      const response = await kinlink.proxy.request(url, requestOptions);
      
      updateStats('success');
      logMessage(\`è¯·æ±‚æˆåŠŸ: \${endpoint}\`, 'success');
      
      return response;
    } catch (error) {
      updateStats('error');
      logMessage(\`è¯·æ±‚å¤±è´¥: \${endpoint} - \${error.message}\`, 'error');
      
      // å®ç°é‡è¯•é€»è¾‘
      if (shouldRetry(error)) {
        return await retryRequest(endpoint, options);
      }
      
      throw error;
    }
  }

  // é‡è¯•è¯·æ±‚
  async function retryRequest(endpoint, options, attempt = 1) {
    if (attempt > PROXY_CONFIG.retryCount) {
      throw new Error(\`è¯·æ±‚å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°: \${endpoint}\`);
    }

    logMessage(\`é‡è¯•è¯·æ±‚ (\${attempt}/\${PROXY_CONFIG.retryCount}): \${endpoint}\`, 'warning');
    
    // ç­‰å¾…é‡è¯•å»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, PROXY_CONFIG.retryDelay * attempt));
    
    try {
      return await makeProxyRequest(endpoint, options);
    } catch (error) {
      return await retryRequest(endpoint, options, attempt + 1);
    }
  }

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
  function shouldRetry(error) {
    const retryableErrors = ['NETWORK_ERROR', 'TIMEOUT', 'SERVER_ERROR'];
    return retryableErrors.some(errorType => error.message.includes(errorType));
  }

  // éªŒè¯è¡¨å•æ•°æ®
  async function validateFormData(formData) {
    try {
      const response = await makeProxyRequest(PROXY_CONFIG.endpoints.validation, {
        method: 'POST',
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        const result = await response.json();
        return result;
            } else {
        return { valid: false, message: 'éªŒè¯æœåŠ¡è¿”å›é”™è¯¯' };
      }
    } catch (error) {
      return { valid: false, message: error.message };
    }
  }

  // éªŒè¯é‚®ç®±å­—æ®µ
  async function validateEmailField(email) {
    if (!email || !email.includes('@')) return;

    try {
      const response = await makeProxyRequest('/api/validate/email', {
        method: 'POST',
        body: JSON.stringify({ email })
      });

      if (response.ok) {
        const result = await response.json();
        if (!result.valid) {
          kinlink.formApi.showMessage('warning', result.message, 3);
        }
            }
          } catch (error) {
      console.warn('é‚®ç®±éªŒè¯å¤±è´¥:', error);
    }
  }

  // åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿ
  async function syncToExternalSystems(data) {
    const syncTasks = [
      syncToUserSystem(data),
      syncToOrderSystem(data),
      updateAnalytics(data)
    ];

    const results = await Promise.allSettled(syncTasks);
    
    results.forEach((result, index) => {
      if (result.status === 'rejected') {
        logMessage(\`åŒæ­¥ä»»åŠ¡ \${index + 1} å¤±è´¥: \${result.reason.message}\`, 'error');
      }
    });
  }

  // åŒæ­¥åˆ°ç”¨æˆ·ç³»ç»Ÿ
  async function syncToUserSystem(data) {
    return await makeProxyRequest(PROXY_CONFIG.endpoints.users, {
      method: 'POST',
      body: JSON.stringify({
        action: 'create_or_update',
        userData: extractUserData(data)
      })
    });
  }

  // åŒæ­¥åˆ°è®¢å•ç³»ç»Ÿ
  async function syncToOrderSystem(data) {
    return await makeProxyRequest(PROXY_CONFIG.endpoints.orders, {
      method: 'POST',
      body: JSON.stringify({
        action: 'create',
        orderData: extractOrderData(data)
      })
    });
  }

  // æ›´æ–°åˆ†ææ•°æ®
  async function updateAnalytics(data) {
    return await makeProxyRequest('/api/analytics/events', {
      method: 'POST',
      body: JSON.stringify({
        event: 'form_submission',
        timestamp: new Date().toISOString(),
        data: data
      })
    });
  }

  // å‘é€é€šçŸ¥
  async function sendNotifications(data) {
    const notifications = [
      {
        type: 'email',
        to: data['æ–‡å­—åˆ—__1è¡Œ__3'], // é‚®ç®±å­—æ®µ
        template: 'submission_confirmation',
        data: data
      },
      {
        type: 'webhook',
        url: 'https://hooks.example.com/form-submission',
        data: data
      }
    ];

    for (const notification of notifications) {
      try {
        await makeProxyRequest(PROXY_CONFIG.endpoints.notifications, {
          method: 'POST',
          body: JSON.stringify(notification)
        });
        logMessage(\`é€šçŸ¥å‘é€æˆåŠŸ: \${notification.type}\`, 'success');
      } catch (error) {
        logMessage(\`é€šçŸ¥å‘é€å¤±è´¥: \${notification.type} - \${error.message}\`, 'error');
      }
    }
  }

  // æå–ç”¨æˆ·æ•°æ®
  function extractUserData(formData) {
    return {
      name: formData['æ–‡å­—åˆ—__1è¡Œ__0'],
      email: formData['æ–‡å­—åˆ—__1è¡Œ__3'],
      phone: formData['æ–‡å­—åˆ—__1è¡Œ__2'],
      company: formData['å•è¡Œæ–‡æœ¬æ¡†_10']
    };
  }

  // æå–è®¢å•æ•°æ®
  function extractOrderData(formData) {
    return {
      customerEmail: formData['æ–‡å­—åˆ—__1è¡Œ__3'],
      orderDate: new Date().toISOString(),
      items: [], // æ ¹æ®è¡¨å•æ•°æ®è§£æ
      total: 0 // æ ¹æ®è¡¨å•æ•°æ®è®¡ç®—
    };
  }

  // é˜Ÿåˆ—ç®¡ç†
  function queueRequest(request) {
    requestQueue.push({
      ...request,
      id: Date.now(),
      status: 'pending'
    });
    
    updateQueueDisplay();
    
    if (!isProcessingQueue) {
      processQueue();
    }
  }

  // å¤„ç†è¯·æ±‚é˜Ÿåˆ—
  async function processQueue() {
    if (isProcessingQueue || requestQueue.length === 0) return;
    
    isProcessingQueue = true;
    
    while (requestQueue.length > 0) {
      const request = requestQueue.shift();
      
      try {
        await processQueuedRequest(request);
        logMessage(\`é˜Ÿåˆ—è¯·æ±‚å¤„ç†æˆåŠŸ: \${request.type}\`, 'success');
      } catch (error) {
        logMessage(\`é˜Ÿåˆ—è¯·æ±‚å¤„ç†å¤±è´¥: \${request.type} - \${error.message}\`, 'error');
      }
      
      updateQueueDisplay();
    }
    
    isProcessingQueue = false;
  }

  // å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
  async function processQueuedRequest(request) {
    switch (request.type) {
      case 'UPDATE_DRAFT':
        return await updateDraft(request);
      case 'SYNC_DATA':
        return await syncSingleData(request);
      default:
        throw new Error(\`æœªçŸ¥è¯·æ±‚ç±»å‹: \${request.type}\`);
    }
  }

  // æ›´æ–°è‰ç¨¿
  async function updateDraft(request) {
    return await makeProxyRequest('/api/drafts/update', {
      method: 'PUT',
      body: JSON.stringify({
        fieldCode: request.fieldCode,
        value: request.value,
        timestamp: request.timestamp
      })
    });
  }

  // æµ‹è¯•APIè¿æ¥
  async function testApiConnection() {
    try {
      logMessage('æµ‹è¯•APIè¿æ¥...', 'info');
      
      const response = await makeProxyRequest('/api/health', {
        method: 'GET'
      });

      if (response.ok) {
        logMessage('APIè¿æ¥æ­£å¸¸', 'success');
        kinlink.formApi.showMessage('success', 'APIè¿æ¥æµ‹è¯•æˆåŠŸ', 2);
        updateConnectionStatus('connected');
      } else {
        throw new Error('APIè¿”å›é”™è¯¯çŠ¶æ€');
      }
    } catch (error) {
      logMessage(\`APIè¿æ¥å¤±è´¥: \${error.message}\`, 'error');
      kinlink.formApi.showMessage('error', 'APIè¿æ¥æµ‹è¯•å¤±è´¥', 2);
      updateConnectionStatus('disconnected');
    }
  }

  // æ‰§è¡Œæ•°æ®åŒæ­¥
  async function performDataSync() {
    try {
      logMessage('å¼€å§‹æ‰‹åŠ¨æ•°æ®åŒæ­¥...', 'info');
      
      const formData = kinlink.formApi.getAllFieldValues();
      await syncToExternalSystems(formData);
      
      logMessage('æ‰‹åŠ¨æ•°æ®åŒæ­¥å®Œæˆ', 'success');
      kinlink.formApi.showMessage('success', 'æ•°æ®åŒæ­¥æˆåŠŸ', 2);
    } catch (error) {
      logMessage(\`æ•°æ®åŒæ­¥å¤±è´¥: \${error.message}\`, 'error');
      kinlink.formApi.showMessage('error', 'æ•°æ®åŒæ­¥å¤±è´¥', 2);
    }
  }

  // æ¸…ç©ºè¯·æ±‚é˜Ÿåˆ—
  function clearRequestQueue() {
    requestQueue = [];
    updateQueueDisplay();
    logMessage('è¯·æ±‚é˜Ÿåˆ—å·²æ¸…ç©º', 'info');
    kinlink.formApi.showMessage('info', 'é˜Ÿåˆ—å·²æ¸…ç©º', 2);
    }

  // æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
  function showDetailedLogs() {
    const logs = document.getElementById('requestLog').innerHTML;
    const newWindow = window.open('', '_blank', 'width=800,height=600');
    newWindow.document.write(\`
      <html>
        <head><title>APIè¯·æ±‚æ—¥å¿—</title></head>
        <body style="font-family: monospace; padding: 20px;">
          <h1>APIè¯·æ±‚è¯¦ç»†æ—¥å¿—</h1>
          <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
            \${logs}
          </div>
        </body>
      </html>
    \`);
  }

  // è®°å½•æ—¥å¿—æ¶ˆæ¯
  function logMessage(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logElement = document.getElementById('requestLog');
    
    if (logElement) {
      const colors = {
        info: '#3498db',
        success: '#27ae60',
        warning: '#f39c12',
        error: '#e74c3c'
      };
      
      const newLog = document.createElement('div');
      newLog.style.color = colors[type] || colors.info;
      newLog.innerHTML = \`[\${timestamp}] \${message}\`;
      
      logElement.appendChild(newLog);
      
      // ä¿æŒæœ€å¤š50æ¡æ—¥å¿—
      while (logElement.children.length > 50) {
        logElement.removeChild(logElement.firstChild);
      }
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      logElement.scrollTop = logElement.scrollHeight;
    }
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  let totalRequests = 0;
  let successfulRequests = 0;
  
  function updateStats(type) {
    totalRequests++;
    if (type === 'success') {
      successfulRequests++;
    }
    
    const successRate = totalRequests > 0 ? Math.round((successfulRequests / totalRequests) * 100) : 100;
    
    document.getElementById('totalRequests').textContent = totalRequests;
    document.getElementById('successRate').textContent = \`\${successRate}%\`;
  }

  // æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤º
  function updateQueueDisplay() {
    document.getElementById('queueLength').textContent = requestQueue.length;
  }

  // æ›´æ–°è¿æ¥çŠ¶æ€
  function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    const statusTexts = {
      connected: 'å·²è¿æ¥',
      disconnected: 'æœªè¿æ¥',
      connecting: 'è¿æ¥ä¸­'
    };
    
    statusElement.textContent = statusTexts[status] || status;
  }

  // å¯åŠ¨å®šæ—¶ä»»åŠ¡
  function startPeriodicTasks() {
    // æ¯30ç§’æ£€æŸ¥è¿æ¥çŠ¶æ€
    setInterval(async () => {
      await testApiConnection();
    }, 30000);
    
    // æ¯10ç§’å¤„ç†é˜Ÿåˆ—
    setInterval(() => {
      if (!isProcessingQueue && requestQueue.length > 0) {
        processQueue();
      }
    }, 10000);
  }
})();`} 
              language="javascript" 
            />
          </TabsContent>
        </Tabs>
      </div>
    </div>

    <div>
      <h2>ä½¿ç”¨è¯´æ˜</h2>
      <div>
        è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œåªéœ€å°†ä»£ç å¤åˆ¶åˆ°æ‚¨çš„kinlinkè‡ªå®šä¹‰JavaScriptä¸­ã€‚è¯·æ ¹æ®æ‚¨çš„å®é™…APIé…ç½®ä¿®æ”¹ä»£ç†åœ°å€ã€è®¤è¯ä¿¡æ¯å’Œç«¯ç‚¹è·¯å¾„ã€‚
      </div>
      <div>
        å®Œæ•´ä»£ç è¯·ä¸‹è½½æŸ¥çœ‹ï¼š
        <a
          href="/samplesCodes/14-kinlink proxy.js"
          className="text-primary hover:underline ml-1"
          download="14-kinlink proxy.js"
        >
          14-kinlink proxy.js
        </a>
      </div>
      <div className="p-4 border rounded-md bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-700">
        <h3 className="font-semibold text-yellow-800 dark:text-yellow-200">æ³¨æ„äº‹é¡¹</h3>
        <div className="text-yellow-800 dark:text-yellow-300">
          ä½¿ç”¨ä»£ç†åŠŸèƒ½éœ€è¦ç¡®ä¿ç›®æ ‡APIæ”¯æŒCORSæˆ–é…ç½®äº†é€‚å½“çš„ä»£ç†æœåŠ¡å™¨ã€‚è®¤è¯ä¿¡æ¯åº”å®‰å…¨å­˜å‚¨ï¼Œé¿å…åœ¨å‰ç«¯ä»£ç ä¸­æš´éœ²æ•æ„Ÿæ•°æ®ã€‚
        </div>
      </div>
    </div>

    <div>
      <h2>APIå‚è€ƒ</h2>
      <div>æ­¤ç¤ºä¾‹ä½¿ç”¨äº†ä»¥ä¸‹kinlink APIï¼š</div>
      <ul>
        <li>
          <code>kinlink.events.on(eventName, callback)</code> -
          æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
        </li>
        <li>
          <code>kinlink.FormEvents.FORM_LOADED</code> - è¡¨å•åŠ è½½å®Œæˆäº‹ä»¶
        </li>
        <li>
          <code>kinlink.FormEvents.BEFORE_SUBMIT</code> - è¡¨å•æäº¤å‰äº‹ä»¶
        </li>
        <li>
          <code>kinlink.FormEvents.AFTER_SUBMIT</code> - è¡¨å•æäº¤åäº‹ä»¶
        </li>
        <li>
          <code>kinlink.FormEvents.FIELD_VALUE_CHANGED</code> - å­—æ®µå€¼å˜åŒ–äº‹ä»¶
        </li>
        <li>
          <code>kinlink.proxy.request(url, options)</code> -
          æ‰§è¡Œä»£ç†HTTPè¯·æ±‚
        </li>
        <li>
          <code>kinlink.formApi.getAllFieldValues()</code> -
          è·å–æ‰€æœ‰å­—æ®µå€¼
        </li>
        <li>
          <code>kinlink.formApi.showMessage(type, message, duration)</code> -
          æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        </li>
      </ul>
    </div>
  </div>
</div> 